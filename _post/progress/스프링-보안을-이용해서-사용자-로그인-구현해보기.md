---
title: '스프링 보안을 이용해서 사용자 로그인 구현해보기'
date: 2019-12-8 10:26:33
category: 'spring'
tags: ["security", "spring", "springboot", "authentication", "authorization", "login", "시큐리티", "로그인", 인증", "인가", "보안", "스프링", "스프링부트"]
---

# 1. 들어가며



## 1.1 인증과 인가란? 

### 1.1.1 인증 (Authenciation)

### 1.1.2 인가 (Authroization)

## 1.2 스프링 보안

- 스프링 보안 3.2부터는 JavaConfig 형식으로도 설정할 수 있다

pg 366

주요 특징?



# 2. 개발 환경

* OS : Mac OS
* IDE: Intellij
* Java : JDK 1.8
* Source code : github
* Software management tool : Maven

# 3. 스프링 보안

## 3.1 전체 구조 정리

<img src="images/스프링-보안을-이용해서-사용자-로그인-구현해보기/image-20191226164218398.png" alt="image-20191226164218398" style="zoom:50%;" />



### 3.1.1 SecurityContext, Authentication, GrantedAuthority

- `SecurityContext`
  - 인증, 인가 정보를 관리하는 오브젝트이다
  - Authentication 오브젝트를 보유하고 있다
- `SecurityContextHolder`
  - 기본적으로 `TheadLocal`에 `SecurityContext` 오브젝트 (ex. `ThreadLocal<SecurityContext>`)를 보관한다
    - TheadLocal로 관리되어 인증 정보를 어디에서든 (Service, Dao에서도) Authentication 오브젝트를 취득하여 인정 정보를 얻어 올 수 있다
- `Authentication X (I) Principal`
  - 인증 정보를 가지고 있는 오브젝트로 인증된 사용자의 정보를 소유한다
    - ex. 사용자명(name)과 패스워드(credentials)를 프로퍼티로 가지고 있다
  - `Authentication` 오브젝트는 복수개의 `GrantedAuthority` 를 소유할 수 있다
  - `UserDetails getPrincipal()` : 인증된 사용자 정보를 얻을 수 있다
- `GrantedAuthority`
  - 인가 정보를 가지고 있는 오브젝트이다
  - 하나의 ROLE은 하나의 `GrantedAuthority` 오브젝트를 가진다
    - 예. 사용자 frank가 admin과 user ROLE을 보유하고 있으면, 
      - `Authentication` 오브젝트는 2개의 `GrantedAuthority` 오브젝트를 보유한다
        - admin ROLE을 나타내는 `GrantedAuthority`
        - user ROLE을 나타재는 `GrantedAuthority`

### 3.1.2 AuthenticationManager, AccessDecisionManager

-  `AuthenticationManager`
  - 인증 처리를 담당하는 오브젝트이다
  - authenticate() 메서드에 인증에 필요한 정보를 넘겨주면 인증 처리가 실행이 된다
  - 인증이 실패하면 `AuthenticationException`이 발생한다
- `AccessDecisionManager`
  - 인가 처리를 담당하는 오브젝트이다
    - HttpSecurity를 인수로 사용하는 configure 메서드에서 설정해주면 `AccessDecisionManager` 오브젝트가 생성이 된다



### 3.1.3 AuthenticationManager

<img src="images/스프링-보안을-이용해서-사용자-로그인-구현해보기/image-20191227213510567.png" alt="image-20191227213510567"  />



- ProviderManager implements AuthenticationManager
  - ProviderManager는 AuthenticationManager 인터페이스의 구현체이다
  - ProviderManager는 다수의 AuthenticationProvider 가지도록 List<AuthenticationProvider> 구조로 관리한다
  - ProviderManager는 순차적으로 인증 처리를 한다. 첫 번째 AuthenticationProvider가 실패하면 다음 AuthenticationProvider에게 인증 처리를 의뢰한다 
    - 마지막까지 인증이 안되면 인증 실패로 간주한다
- (I) AuthenticationProvider
  - 실제로 데이터 베이스, LDAP 등에 보관된 정보로 인증을 실시하는 오브젝트이다
  - AuthenticationProvider에 대한 구현체는 여러 가지가 존재를 한다
    - DaoAuthenticationProvider : UserDetailService를 사용해서 인증 처리를 한다
- (I) UserDetailService
  - UserDetailService의 구현체
    - InMemoryDaoImpl : 인증 정보를 메모리에서 관리한다
    - JdbcDaoImpl : 인증 정보를 데이터베이스에서 관리한다

# 4. FAQ

## 4.1 SecurityContext 오브젝트는 왜 TheadLocal로 관리되나?

SecurityContextHolder가 SecurityContext 오프젝트를 관리함

SecurityContextHolder 클래스는 디폴트로 SecurityContext 오브젝트를 ThreadLocal에서 관리함

스프링 보안는 스레드 사잉에서 인증정보를 공유하는 방식도 제공함



## 4.2 스프링 보안관련해서 Unit Test를 어떻게 작성할 수 있나? 

pg 393

## 4.3 WebMvcConfigurerAdapter deprecated 되어 있는데 어떤 걸 사용해야 하나? 

스프링부트 1.5.x에서는 WebMvcConfig 설정시 WebMvcConfigurerAdapter을 상속 받아서 설정하였지만,  2.0.x로 넘어가면서 WebMvcConfigurer를 구현하는 방식으로 아래와 같이 변경되었습니다. 

```java
@Deprecated
public class WebMvcConfig extends WebMvcConfigurerAdapter {
  //스프릥부트 1.5.x
}

public class WebMvcConfig implements WebMvcConfigurer {
  //스프링부트 2.0.x
}
```

참고

- [https://hspmuse.tistory.com/entry/springboot-15x-%EC%97%90%EC%84%9C-springboot-20x-%EB%84%98%EC%96%B4%EA%B0%80%EB%A9%B4%EC%84%9C-%EC%83%9D%EA%B8%B4%EC%9D%BC](https://hspmuse.tistory.com/entry/springboot-15x-에서-springboot-20x-넘어가면서-생긴일)

# 5. 참고

* Spring Security
	* [https://sjh836.tistory.com/165](https://sjh836.tistory.com/165)
	* https://www.baeldung.com/spring-security-login
	* https://www.devglan.com/spring-security/spring-boot-security-custom-form-login-example
	* https://www.javainuse.com/spring/sprboot_sec
	* https://xmfpes.github.io/spring/spring-security/
	* https://howtodoinjava.com/spring5/security5/login-form-example/
	* [https://a1010100z.tistory.com/entry/Spring-Spring-security-%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%B4%EB%B3%B4%EC%9E%90-%ED%9A%8C%EC%9B%90%EA%B0%80%EC%9E%85%EB%B6%80%ED%84%B0-%EB%A1%9C%EA%B7%B8%EC%9D%B8%EA%B9%8C%EC%A7%80-Spring-boot-Gradle-MyBatis-MySQL](https://a1010100z.tistory.com/entry/Spring-Spring-security-를-사용해보자-회원가입부터-로그인까지-Spring-boot-Gradle-MyBatis-MySQL)
	* http://progtrend.blogspot.com/2018/07/spring-boot-security.html
* 스프링 보안 구조
  * [https://www.google.com/imgres?imgurl=https%3A%2F%2Fwww.techtalks.lk%2Fassets%2Fimages%2Fposts%2F1540960050&imgrefurl=https%3A%2F%2Fshazsterblog.blogspot.com%2F2018%2F10%2F&docid=H-sGr7bft_wZZM&tbnid=Z6ba1it6PmKpaM%3A&vet=10ahUKEwjf_LXd5dXmAhVlF6YKHf-DDOkQMwh0KCUwJQ..i&w=698&h=468&itg=1&bih=946&biw=1280&q=spring%20security%20core&ved=0ahUKEwjf_LXd5dXmAhVlF6YKHf-DDOkQMwh0KCUwJQ&iact=mrc&uact=8](https://www.google.com/imgres?imgurl=https%3A%2F%2Fwww.techtalks.lk%2Fassets%2Fimages%2Fposts%2F1540960050&imgrefurl=https%3A%2F%2Fshazsterblog.blogspot.com%2F2018%2F10%2F&docid=H-sGr7bft_wZZM&tbnid=Z6ba1it6PmKpaM%3A&vet=10ahUKEwjf_LXd5dXmAhVlF6YKHf-DDOkQMwh0KCUwJQ..i&w=698&h=468&itg=1&bih=946&biw=1280&q=spring security core&ved=0ahUKEwjf_LXd5dXmAhVlF6YKHf-DDOkQMwh0KCUwJQ&iact=mrc&uact=8)
  * [https://www.google.com/imgres?imgurl=https%3A%2F%2Fstatic.packt-cdn.com%2Fproducts%2F9781788995979%2Fgraphics%2Ff142cc88-0da8-4a73-86a6-b8425722c788.png&imgrefurl=https%3A%2F%2Fsubscription.packtpub.com%2Fbook%2Fapplication_development%2F9781788995979%2F1%2Fch01lvl1sec21%2Fworking-of-spring-security&docid=x57oN-f--RMwRM&tbnid=1fpKhd4nifzJpM%3A&vet=10ahUKEwjf_LXd5dXmAhVlF6YKHf-DDOkQMwh_KDAwMA..i&w=1452&h=796&bih=946&biw=1280&q=spring%20security%20core&ved=0ahUKEwjf_LXd5dXmAhVlF6YKHf-DDOkQMwh_KDAwMA&iact=mrc&uact=8](https://www.google.com/imgres?imgurl=https%3A%2F%2Fstatic.packt-cdn.com%2Fproducts%2F9781788995979%2Fgraphics%2Ff142cc88-0da8-4a73-86a6-b8425722c788.png&imgrefurl=https%3A%2F%2Fsubscription.packtpub.com%2Fbook%2Fapplication_development%2F9781788995979%2F1%2Fch01lvl1sec21%2Fworking-of-spring-security&docid=x57oN-f--RMwRM&tbnid=1fpKhd4nifzJpM%3A&vet=10ahUKEwjf_LXd5dXmAhVlF6YKHf-DDOkQMwh_KDAwMA..i&w=1452&h=796&bih=946&biw=1280&q=spring security core&ved=0ahUKEwjf_LXd5dXmAhVlF6YKHf-DDOkQMwh_KDAwMA&iact=mrc&uact=8)
* 책 : 스프링4 입문
